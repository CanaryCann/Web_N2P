<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>{{ details.metadata.name }} - Nessus Report</title>
    <link rel="stylesheet" href="../static/css/report.css" />
  </head>
  <body>
    <section class="cover-page">
      <div class="cover-meta">
        <h1>{{ details.metadata.name }}</h1>
        <p class="subtitle">Customer: {{ details.metadata.customer or 'N/A' }}</p>
        <p class="subtitle">Scan date: {{ details.metadata.scan_date or 'N/A' }}</p>
        <p class="subtitle">Generated: {{ details.generated_at.strftime('%Y-%m-%d %H:%M UTC') }}</p>
      </div>
    </section>

    <section class="section">
      <h2>Executive Summary</h2>
      <div class="kpi-grid">
        <div class="kpi">
          <span class="kpi-label">Total Findings</span>
          <span class="kpi-value">{{ details.aggregates.total_findings }}</span>
        </div>
        <div class="kpi">
          <span class="kpi-label">Affected Hosts</span>
          <span class="kpi-value">{{ details.aggregates.affected_hosts }}</span>
        </div>
        <div class="kpi">
          <span class="kpi-label">Average CVSS</span>
          <span class="kpi-value">{{ details.aggregates.average_cvss or 'n/a' }}</span>
        </div>
      </div>
      <table class="summary-table">
        <thead>
          <tr>
            <th>Severity</th>
            <th>Findings</th>
          </tr>
        </thead>
        <tbody>
          {% for severity, value in details.aggregates.severity_counts %}
          <tr>
            <td><span class="badge severity-{{ severity|lower }}">{{ severity }}</span></td>
            <td>{{ value }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </section>

    <section class="section charts">
      <div class="chart">
        <h3>Findings by Severity</h3>
        <img src="{{ charts.severity }}" alt="Severity chart" />
      </div>
      <div class="chart">
        <h3>Risk Factor Distribution</h3>
        <img src="{{ charts.risks }}" alt="Risk chart" />
      </div>
      <div class="chart">
        <h3>Top Hosts</h3>
        <img src="{{ charts.hosts }}" alt="Top hosts chart" />
      </div>
      <div class="chart">
        <h3>Top Plugin Families</h3>
        <img src="{{ charts.families }}" alt="Top plugin families chart" />
      </div>
    </section>

    <section class="section">
      <h2>Host Findings Summary</h2>
      <table class="data-table">
        <thead>
          <tr>
            <th>Host</th>
            <th>IP</th>
            {% for label in severity_order %}
            <th>{{ label }}</th>
            {% endfor %}
            <th>Total</th>
          </tr>
        </thead>
        <tbody>
          {% for host in details.host_summaries %}
          <tr>
            <td>{{ host.host }}</td>
            <td>{{ host.ip_address or 'â€”' }}</td>
            {% for label in severity_order %}
            <td>{{ host.severity_totals[label] }}</td>
            {% endfor %}
            <td>{{ host.total_findings }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </section>

    <section class="section">
      <h2>Finding Details</h2>
      <table class="data-table">
        <thead>
          <tr>
            <th>Severity</th>
            <th>Host</th>
            <th>Plugin</th>
            <th>Risk</th>
            <th>CVSS</th>
            <th>CVEs</th>
            <th>Description</th>
            <th>Recommendation</th>
          </tr>
        </thead>
        <tbody>
          {% for finding in details.findings %}
          <tr>
            <td><span class="badge severity-{{ finding.severity_label|lower }}">{{ finding.severity_label }}</span></td>
            <td>{{ finding.host }}</td>
            <td>{{ finding.plugin_name }}</td>
            <td>{{ finding.risk_factor }}</td>
            <td>{{ finding.cvss_base or 'n/a' }}</td>
            <td>{{ finding.cves|join(', ') if finding.cves else 'None' }}</td>
            <td>{{ finding.description }}</td>
            <td>{{ finding.solution or 'Refer to vendor guidance.' }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </section>
  </body>
</html>
